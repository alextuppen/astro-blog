---
import type { CollectionEntry } from "astro:content";
import Root from "../layouts/Root.astro";
import { Section } from "../components";
import dayjs from "dayjs";
import duration from "dayjs/plugin/duration";
import relativeTime from "dayjs/plugin/relativeTime";
// import { FormattedDate } from "../components/Display";

type Props = CollectionEntry<"recipes">["data"];

const {
  name,
  image,
  description,
  creativeWorkStatus,
  prepTime,
  cookTime,
  totalTime,
  recipeYield,
  recipeIngredient,
  tool,
  recipeInstructions,
} = Astro.props;

dayjs.extend(duration);
dayjs.extend(relativeTime);

const prepDuration = dayjs.duration(prepTime).humanize();
const cookDuration = dayjs.duration(cookTime).humanize();
const totalDuration = dayjs.duration(totalTime).humanize();
---

<Root title={name} description={description}>
  <Section>
    <h1>{name}</h1>
    <img width="400" src={image[0]} />
    {
      creativeWorkStatus && creativeWorkStatus === "draft" && (
        <div class="draft">
          <img
            src="/icons/components/exclamation-circle.svg"
            class="draft-icon"
          />
          <h3 class="draft-title">Draft recipe</h3>
          <span class="draft-text">
            This recipe is in draft state, it is unfinished and still being
            refined.
          </span>
        </div>
      )
    }
    <div class="grid">
      <div class="description-card">
        <p>{description}</p>
        <p>{`Serves: ${recipeYield}`}</p>
        <p>{`Prep time: ${prepDuration}`}</p>
        <p>{`Cook time: ${cookDuration}`}</p>
        <p>{`Total time: ${totalDuration}`}</p>
      </div>
      <div class="tools-ingredients-card">
        <div class="tools-ingredients">
          <h2>Tools:</h2>
          <ul class="tools-ingredients-list">
            {
              tool.map(({ name }) => (
                <li class="tools-ingredients-item">
                  <img
                    src="/logo/bulletPoints/white.svg"
                    class="bullet-point"
                  />
                  <span>{name}</span>
                </li>
              ))
            }
          </ul>
        </div>
        <div class="tools-ingredients">
          <h2>Ingredients:</h2>
          <ul class="tools-ingredients-list">
            {
              recipeIngredient.map((ingredient) => (
                <li class="tools-ingredients-item">
                  <img
                    src="/logo/bulletPoints/white.svg"
                    class="bullet-point"
                  />
                  <span>{ingredient}</span>
                </li>
              ))
            }
          </ul>
        </div>
      </div>
      <div class="method-card">
        <h2>Method</h2>
        <ol class="methods">
          {
            recipeInstructions.map((instruction) => (
              <li class="method">
                <h4 class="method-title">{instruction.name}</h4>
                {"text" in instruction && (
                  <p class="method-text">{instruction.text}</p>
                )}
                {"itemListElement" in instruction &&
                  instruction.itemListElement.map((element) => {
                    switch (element["@type"]) {
                      case "HowToDirection":
                        return <p class="method-text">{element.text}</p>;
                      case "HowToTip":
                        return (
                          <div class="method-tip">
                            <div class="tip-title">
                              <img src="/icons/components/light-bulb.svg" />
                              <h5>Tip</h5>
                            </div>
                            <p class="method-text">{element.text}</p>
                          </div>
                        );
                      default:
                        throw new Error(
                          `itemListElement["@type"] switch has an illegal value: ${element["@type"]}`
                        );
                    }
                  })}
              </li>
            ))
          }
        </ol>
      </div>
    </div>
  </Section>
</Root>

<style lang="scss">
  @import "../styles/_globals.scss";

  .grid {
    width: 100%;
    display: grid;
    grid-template-areas: "description" "ingredients" "method";
    gap: var(--padding-double);
    align-items: start;
  }

  .description-card,
  .tools-ingredients-card {
    @include elev-1();
    padding: var(--padding-double) var(--padding);
  }

  .description-card {
    grid-area: description;
  }

  .tools-ingredients-card {
    grid-area: ingredients;
  }

  .method-card {
    grid-area: method;
  }

  //   .imageWrapper {
  //   position: relative;
  //   width: 100%;
  //   height: 20rem;
  // }

  // .imageWrapper > span > img {
  //   border-radius: var(--border-radius-double);
  // }

  .description-items,
  .tools-ingredients {
    width: 75%;
  }

  .draft {
    padding: var(--padding);
    @include elev-3();
    display: grid;
    grid-template-areas:
      "icon title"
      "icon text";
    row-gap: var(--padding-half);
    column-gap: var(--padding);
    border: var(--border-width) solid $secondary;
    border-radius: var(--border-radius);
  }

  .draft-icon {
    grid-area: icon;
    width: calc(var(--font-size) * 3);
    height: 100%;
    color: $text;
  }

  .draft-title {
    grid-area: title;
    justify-self: start;
  }

  .draft-text {
    grid-area: text;
    justify-self: start;
    text-align: start;
  }

  .description-items-list {
    margin: unset;
  }

  .tools-ingredients-list {
    margin-top: var(--padding);
  }

  .description-items-list,
  .tools-ingredients-list {
    padding-left: 0;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--padding-half);
  }

  .description-item,
  .tools-ingredients-item {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: var(--padding);
    color: $text;
    text-align: left;
  }

  //   .description-item > svg {
  //   font-size: var(--font-size);
  // }

  .description-item > span {
    white-space: nowrap;
  }

  .bullet-point {
    width: var(--font-size);
  }

  .methods {
    padding-left: 0;
    display: flex;
    flex-direction: column;
    gap: var(--padding-triple);
    counter-reset: method;
    list-style-type: none;
    color: $text;
    text-align: left;
  }

  .method {
    display: flex;
    flex-direction: column;
    gap: var(--padding);
    counter-increment: method;
  }

  .method-title {
    display: flex;
    gap: var(--padding-half);
  }

  .method-title::before {
    content: counter(method) ".";
  }

  .method-tip {
    display: flex;
    padding: var(--padding-half);
    @include elev-6();
    flex-direction: column;
    gap: var(--padding-half);
    border: var(--border-width) solid $secondary;
    border-radius: var(--border-radius);
  }

  .tip-title {
    display: flex;
    align-items: center;
    gap: var(--padding-half);
  }

  @include bp-small {
    // .imageWrapper {
    //   height: 30rem;
    // }

    .description-card,
    .tools-ingredients-card {
      border-radius: var(--border-radius);
    }

    .description-items-list,
    .tools-ingredients-list {
      grid-template-columns: 1fr 1fr;
    }

    .description-items,
    .tools-ingredients {
      width: 90%;
    }
  }

  @include bp-medium {
    // .imageWrapper {
    //   height: 40rem;
    // }

    .description-card,
    .tools-ingredients-card {
      padding: var(--padding-double);
    }

    .description {
      width: 90%;
    }

    .description-items-list-wrapper {
      display: flex;
      flex-direction: column;
      gap: var(--padding);
    }

    .description-items-list {
      margin-top: unset;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: var(--padding);
    }

    .tools-ingredients-list {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .description-items,
    .tools-ingredients {
      width: 100%;
    }

    .description-item {
      padding: 0 var(--padding);
    }
  }

  @include bp-large {
    // .imageWrapper {
    //   height: 45rem;
    // }

    .grid {
      grid-template-areas: "description description" "ingredients method";
      grid-template-columns: 30% 1fr;
    }

    .tools-ingredients-list {
      grid-template-columns: 1fr;
    }
  }

  // @include bp-xl {
  //   .imageWrapper {
  //     height: 50rem;
  //   }
  // }
</style>
